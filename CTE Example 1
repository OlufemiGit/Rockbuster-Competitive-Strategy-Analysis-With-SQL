# **SQL CTE Query to the top 10 countries and cities by customer count, calculates total payments for customers in these cities, and determines the average total payment among them:**

WITH top_countries AS (
    -- Get the top 10 countries with the most customers
    SELECT D.country
    FROM customer A
    INNER JOIN address B ON A.address_id = B.address_id
    INNER JOIN city C ON B.city_id = c.city_id
    INNER JOIN country D ON C.country_id = D.country_id
    GROUP BY D.country
    ORDER BY COUNT(A. customer_id) DESC
    LIMIT 10
)

top_cities AS (
    --Get the top 10 cities from the top 10 countries with the most customers
    SELECT c.city
    FROM customer A
    INNER JOIN address E ON A.address_id = B.address_id
    INNER JOIN city C ON B.city_id = c.city_id
    INNER JOIN country D ON c.country_id = D.country_id
    WHERE D.country IN (SELECT country FROM top_countries)
    GROUP BY C.city
    ORDER BY COUNT(A. customer_id) DESC
    LIMIT 10
)

total_payment_table AS (
    -- Calculate total payment for customers in the selected cities
    SELECT
    B.customer_id,
    B.first_name,
    B.last_name,
    D.city,
    E.country,
    SUM(A. amount) AS total_amount_paid
    FROM paynent A
    INNER JOIN customer B ON A.customer_id = B.customer_id
    INNER JOIN address C ON B.address_id = C.address_id
    INNER JOIN city D ON C.city_id = D.city_id
    INNER JOIN country E ON D.country_id = E.country_id
    WHERE D.city IN (SELECT city FROM top_cities)
    GROUP BY B.customer_id, B.first_name, B.last_name, D.city, E.country
    ORDER BY SUM(A.amoumt) DESC
    LIMIT 5
)

  -- Get the average of total payments
  SELECT AVG(total_amount_paid) AS average FROM total_payment_table;
